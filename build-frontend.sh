#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–±—ñ—Ä–∫–∏ —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É
# –î–æ–º–µ–Ω: iryslots.xyz

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

PROJECT_DIR="/var/www/iryslots"

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

warning() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}

error() {
    echo -e "${RED}[ERROR] $1${NC}"
    exit 1
}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [[ $EUID -ne 0 ]]; then
   error "–¶–µ–π —Å–∫—Ä–∏–ø—Ç –ø–æ–≤–∏–Ω–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç–∏—Å—è –∑ –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
fi

log "üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É..."

cd $PROJECT_DIR

# –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É –∑ GitHub
log "–û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É –∑ GitHub..."
git pull origin main || git pull origin master || warning "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∑ git"

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
log "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è/–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
npm install

# –ó–±—ñ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç—É
log "–ó–±—ñ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É..."
npm run build

# –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∑–±—É–¥–æ–≤–∞–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤
if [ -d "dist" ]; then
    log "–ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∑–±—É–¥–æ–≤–∞–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤..."
    
    # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è backup —Å—Ç–∞—Ä–æ—ó –≤–µ—Ä—Å—ñ—ó
    if [ -f "index.html" ]; then
        mkdir -p backup
        cp index.html backup/index.html.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
    fi
    
    # –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤
    cp -r dist/* ./
    
    log "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ"
else
    error "–î–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è dist –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –ø—ñ—Å–ª—è –∑–±—ñ—Ä–∫–∏"
fi

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É
log "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É..."
chown -R www-data:www-data $PROJECT_DIR
chmod -R 755 $PROJECT_DIR

# –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è nginx (–¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É)
log "–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è nginx..."
systemctl reload nginx

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∞–π—Ç—É
log "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∞–π—Ç—É..."
if curl -f -s https://iryslots.xyz > /dev/null; then
    log "‚úÖ –°–∞–π—Ç –ø—Ä–∞—Ü—é—î: https://iryslots.xyz"
else
    warning "‚ö†Ô∏è –°–∞–π—Ç –º–æ–∂–µ –±—É—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π"
fi

echo -e "${GREEN}üéâ –§—Ä–æ–Ω—Ç–µ–Ω–¥ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!${NC}"
echo -e "${GREEN}üåê –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ: https://iryslots.xyz${NC}"